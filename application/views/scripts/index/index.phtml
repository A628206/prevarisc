<div id="dashboard">
    <div class="grid-gutter"></div>
    <div class="grid-sizer"></div>
</div>

<div id="reponse-modal" class="modal hide fade" ></div>

<script type="text/javascript">

    document.addEventListener('DOMContentLoaded', function() {

        // Gestion des boites modales (ajout d'un message)
        $("a[data-toggle='modal']").click(function() {
            var target = $(this).attr("data-target");
            var url = $(this).attr("href");
            $(target).load(url);
        });

        // On initialise le dashboard via packery
        var dashboard = $('#dashboard').packery({
            itemSelector: '.panel',
            gutter: '.grid-gutter',
            columnWidth: '.grid-sizer',
            rowHeight: 44,
            percentPosition: true,
            transitionDuration: 0
        });

        // On ajoute les blocs au dashboard de l'utilisateur dans l'ordre voulu
        <?php foreach($this->blocs as $bloc) : ?>
            var item = $('<?php echo json_encode($this->partial('index/partials/blocs/bloc.phtml', $bloc)); ?>');
            dashboard.append(item).packery('appended', item);
            item.draggable({handle: ".panel-heading", containment: "parent"});
            dashboard.packery('bindUIDraggableEvents', item);
        <?php endforeach ?>

        // On réactive les transitions
        var dashboard = $('#dashboard').packery({
            transitionDuration: '0.4s'
        });

        // On lance la récupération des contenus
        <?php foreach($this->blocs as $bloc) : ?>
            $('#<?php echo $bloc['id'] ?>').find('a.btn').click(function() {
                $.ajax({
                    type: 'get',
                    url: "/index/bloc",
                    data: {id: '<?php echo $bloc['id'] ?>', light: 1},
                    beforeSend : function() {
                        $('#<?php echo $bloc['id'] ?>').find('.panel-body').css('text-align', 'left');
                        $('#<?php echo $bloc['id'] ?>').find('.panel-body').html('<p style="text-align: center"><img src="/img/load.gif" /></p>');
                    },
                    success: function(data) {
                        $('#<?php echo $bloc['id'] ?>').find('.panel-body').html(data);
                        dashboard.packery('layout');
                        bindEtsMarquee($('#<?php echo $bloc['id'] ?>'));
                        bindEtsPopup($('#<?php echo $bloc['id'] ?>'));
                    }
                });
            });
        <?php endforeach ?>

        // Sauvegarde de la position des blocs
        dashboard.on('dragItemPositioned', function() {
            dashboard.packery('layout');
            setTimeout(function() {
                var blocs = dashboard.packery('getItemElements').map(function(bloc) {
                    return $(bloc).attr('id');
                });
                $.post("/api/1.0/user/preferences", {
                    id: <?php echo $this->user['ID_UTILISATEUR'] ?>,
                    preferences: {'DASHBOARD_BLOCS': blocs}
                });
            }, 400);
        });

    });

</script>
